<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    
    <button onclick="deviceConnect()">Connect</button>
    <button onclick="writePort()">sendData</button>
    <button onclick="closePort()">closePort</button>

    <script>
      let device;
      let port = navigator.serial;
      let portOptions = {
        baudRate: 9600,
        dataBits: 8,
        parity: "none",
        stopBits: 1
      }
      
      let baudRate = 9600;
      
      port.onconnect = event => { console.log(event) };
      port.ondisconnect = event => { console.log(event) };

      async function deviceConnect(){
        await port.requestPort();
        await port.getPorts().then(devices => {
          console.log(devices);
          
          device = devices[0];

          device.open(portOptions).then(result => {
            console.log("Connected");
            readPort();
          });
        })
      }
        
        async function readPort(){
          const textDecoder = new TextDecoderStream();
          const readableStreamClosed = device.readable.pipeTo(textDecoder.writable);
          const reader = textDecoder.readable.getReader();
          
          while (true) {
            const { value, done } = await reader.read();
            if (done) {
              reader.releaseLock();
              break;
            }
            
            console.log(value);
          }
        }


        async function writePort(){
          let payload = "AT+SEND=2:000000000000000000000000000000000000000000000026";
          payload += "\r\n";
          console.log(payload);
         
          const encoder = new TextEncoder();
          const writer = device.writable.getWriter();
          await writer.write(encoder.encode(payload));
          writer.releaseLock();
        }

        async function closePort(){
          await device.close();
        }

    </script>
</body>
</html>


