<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- CSS only -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
</head>
<body>
    
    <button onclick="deviceConnect()">Connect</button>
    <button onclick="writePort()">sendData</button>
    <button onclick="closePort()">closePort</button>
    
    
    <div class="input-group">
      <textarea class="form-control" aria-label="With textarea" id="txt_payload"></textarea>
    </div>


    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>
    
    <script>
      let device;
      let port = navigator.serial;
      let portOptions = {
        baudRate: 9600,
        dataBits: 8,
        parity: "none",
        stopBits: 1
      }
      
      let baudRate = 9600;
      
      port.onconnect = event => { console.log(event) };
      port.ondisconnect = event => { console.log(event) };

      async function deviceConnect(){
        await port.requestPort();
        await port.getPorts().then(devices => {
          console.log(devices);
          
          device = devices[0];

          device.open(portOptions).then(result => {
            console.log("Connected");
            readPort();
          });
        })
      }
        
        async function readPort(){
          const textDecoder = new TextDecoderStream();
          const readableStreamClosed = device.readable.pipeTo(textDecoder.writable);
          const reader = textDecoder.readable.getReader();
          
          try {
            while (true) {
              const { value, done } = await reader.read();
              if (done) {
                // |reader| has been canceled.
                break;
              }
              // Do something with |value|...
              console.log(value);
              document.getElementById('txt_payload').value += value;
            }
          } catch (error) {
            // Handle |error|...
          } finally {
            reader.releaseLock();
          }
        }


        async function writePort(){
          let payload = "AT+SEND=2:000000000000000000000000000000000000000000000026";
          payload += "\r\n";
          console.log(payload);
         
          const encoder = new TextEncoder();
          const writer = device.writable.getWriter();
          await writer.write(encoder.encode(payload));
          writer.releaseLock();
        }

        async function closePort(){
          await device.readable.releaseLock();
          await device.close();
        }

    </script>

    
</body>
</html>


